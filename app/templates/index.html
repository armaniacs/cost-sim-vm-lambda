{% extends "base.html" %}

{% block title %}AWS Lambda vs VM Cost Simulator{% endblock %}

{% block content %}
<div class="row">
    <!-- Input Panel -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Configuration</h5>
            </div>
            <div class="card-body">
                <!-- Lambda Configuration -->
                <form id="costCalculatorForm">
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-cloud me-2"></i>AWS Lambda Configuration
                        </h6>
                        
                        <div class="mb-3">
                            <label for="lambdaMemory" class="form-label">Memory Size</label>
                            <select id="lambdaMemory" class="form-select" required>
                                <option value="128">128 MB</option>
                                <option value="512" selected>512 MB</option>
                                <option value="1024">1024 MB</option>
                                <option value="2048">2048 MB</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="executionTime" class="form-label">Execution Time</label>
                            <select id="executionTime" class="form-select" required>
                                <option value="1">1 second</option>
                                <option value="10" selected>10 seconds</option>
                                <option value="30">30 seconds</option>
                                <option value="60">60 seconds</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="executionFrequency" class="form-label">Execution Frequency</label>
                            <select id="executionFrequency" class="form-select" required>
                                <option value="1000000" selected>1M/month</option>
                                <option value="2592000">1/second (~2.59M/month)</option>
                                <option value="25920000">10/second (~25.9M/month)</option>
                                <option value="259200000">100/second (~259M/month)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="egressTransfer" class="form-label">
                                <i class="bi bi-cloud-arrow-up me-1"></i>Egress Transfer per Request
                            </label>
                            <div class="input-group">
                                <select id="egressPreset" class="form-select">
                                    <option value="10">10 KB</option>
                                    <option value="100" selected>100 KB</option>
                                    <option value="1000">1 MB</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="egressCustom" class="form-control" 
                                       placeholder="KB" min="0" max="10000000" step="1" 
                                       style="display: none;">
                                <span class="input-group-text">KB</span>
                            </div>
                            <div class="form-text">
                                Amount of data transferred from Lambda/VM to internet per request
                            </div>
                            <div id="egressError" class="invalid-feedback" style="display: none;">
                                Transfer amount must be 0 or positive
                            </div>
                        </div>

                        <!-- Egress Rate Customization -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-gear me-1"></i>Egress Rates (USD/GB)
                            </label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="awsEgressRate" class="form-label text-muted small">AWS Lambda/EC2</label>
                                    <input type="number" id="awsEgressRate" class="form-control form-control-sm" 
                                           value="0.114" min="0" step="0.001" placeholder="0.114">
                                </div>
                                <div class="col-md-6">
                                    <label for="gcpEgressRate" class="form-label text-muted small">Google Cloud</label>
                                    <input type="number" id="gcpEgressRate" class="form-control form-control-sm" 
                                           value="0.12" min="0" step="0.001" placeholder="0.12">
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-6">
                                    <label for="sakuraEgressRate" class="form-label text-muted small">Sakura Cloud (JPY/GB)</label>
                                    <input type="number" id="sakuraEgressRate" class="form-control form-control-sm" 
                                           value="0.0" min="0" step="0.001" placeholder="0.0">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" id="resetEgressRates" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Reset to Default
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                Customize egress pricing rates. Defaults: AWS 0.114, GCP 0.12, Sakura 0.0 (free)
                            </div>
                        </div>

                        <!-- Egress Free Tier Toggle -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeEgressFreeTier" checked>
                            <label class="form-check-label" for="includeEgressFreeTier">
                                <i class="bi bi-cloud-arrow-up me-1"></i>Include 100GB/month free egress (AWS & Google Cloud)
                            </label>
                            <div class="form-text">
                                AWS and Google Cloud provide 100GB/month of free internet egress transfer
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeFreeTier" checked>
                            <label class="form-check-label" for="includeFreeTier">
                                Include AWS Free Tier
                            </label>
                        </div>
                    </div>

                    <!-- VM Configuration -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-server me-2"></i>VM Comparison
                        </h6>
                        
                        <!-- EC2 Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareEC2" checked>
                                <label class="form-check-label" for="compareEC2">
                                    AWS EC2
                                </label>
                            </div>
                            <select id="ec2InstanceType" class="form-select form-select-sm">
                                <option value="t3.micro">t3.micro (1 GB, $9.79/month)</option>
                                <option value="t3.small" selected>t3.small (2 GB, $19.58/month)</option>
                                <option value="t3.medium">t3.medium (4 GB, $39.17/month)</option>
                                <option value="t3.large">t3.large (8 GB, $79.42/month)</option>
                                <option value="c5.large">c5.large (4 GB, $69.12/month)</option>
                                <option value="c5.xlarge">c5.xlarge (8 GB, $140.16/month)</option>
                            </select>
                        </div>

                        <!-- Sakura Cloud Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareSakura" checked>
                                <label class="form-check-label" for="compareSakura">
                                    Sakura Cloud
                                </label>
                            </div>
                            <select id="sakuraInstanceType" class="form-select form-select-sm">
                                <option value="1core_1gb">1 core/1 GB (¥1,595/month)</option>
                                <option value="2core_2gb">2 core/2 GB (¥3,190/month)</option>
                                <option value="2core_4gb" selected>2 core/4 GB (¥4,180/month)</option>
                                <option value="4core_8gb">4 core/8 GB (¥7,370/month)</option>
                                <option value="6core_12gb">6 core/12 GB (¥11,560/month)</option>
                            </select>
                        </div>

                        <!-- Google Cloud Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareGCP" checked>
                                <label class="form-check-label" for="compareGCP">
                                    Google Cloud
                                </label>
                            </div>
                            <select id="gcpInstanceType" class="form-select form-select-sm">
                                <option value="e2-micro">e2-micro (0.25 vCPU, 1GB)</option>
                                <option value="e2-small">e2-small (0.5 vCPU, 2GB)</option>
                                <option value="e2-medium">e2-medium (1 vCPU, 4GB)</option>
                                <option value="n2-standard-1">n2-standard-1 (1 vCPU, 4GB)</option>
                                <option value="n2-standard-2">n2-standard-2 (2 vCPU, 8GB)</option>
                                <option value="c2-standard-4">c2-standard-4 (4 vCPU, 16GB)</option>
                            </select>
                        </div>

                        <!-- Lambda Equivalent Recommendation -->
                        <div class="alert alert-info py-2 px-3 mb-0">
                            <small class="d-block mb-1"><i class="bi bi-info-circle me-1"></i>Lambda Equivalent Recommendations:</small>
                            <small id="vmRecommendations" class="text-muted">Select Lambda memory to see recommendations</small>
                        </div>
                    </div>

                    <!-- Currency Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-warning mb-3">
                            <i class="bi bi-currency-yen me-2"></i>Currency Settings
                        </h6>
                        
                        <div class="mb-3">
                            <label for="exchangeRate" class="form-label">Exchange Rate (JPY/USD)</label>
                            <input type="number" id="exchangeRate" class="form-control" value="150" min="50" max="300" step="1" onchange="handleCurrencyChange()">
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="displayCurrency" onchange="handleCurrencyChange()">
                            <label class="form-check-label" for="displayCurrency">
                                Display in JPY
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-calculator me-2"></i>Calculate
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Results -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-speedometer me-2"></i>Quick Results</h6>
            </div>
            <div class="card-body">
                <div id="quickResults">
                    <p class="text-muted mb-0">Configure and calculate to see results</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-lg-8">
        <!-- Graph -->
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Cost Comparison Graph</h5>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 400px;">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-table me-2"></i>Detailed Data
                    <button class="btn btn-sm btn-outline-light float-end" id="exportCSV">
                        <i class="bi bi-download me-1"></i>Export CSV
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th>Executions/Month</th>
                                <th>Lambda Cost</th>
                                <th>EC2 Cost</th>
                                <th>Sakura Cost</th>
                                <th>Break-even</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Break-even Points -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Break-even Analysis</h6>
            </div>
            <div class="card-body" id="breakEvenAnalysis">
                <p class="text-muted mb-0">Calculate to see break-even points</p>
            </div>
        </div>
    </div>
</div>


<!-- Error Alert Template -->
<div id="errorTemplate" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="errorMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let costChart = null;
let comparisonData = [];
let lastBreakEvenData = [];

// Simple loading indicator using button state
function showCalculating() {
    const calculateBtn = document.querySelector('button[type="submit"]');
    calculateBtn.disabled = true;
    calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculating...';
}

function hideCalculating() {
    const calculateBtn = document.querySelector('button[type="submit"]');
    calculateBtn.disabled = false;
    calculateBtn.innerHTML = '<i class="bi bi-calculator me-2"></i>Calculate';
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page loaded - initializing cost calculator...');
    console.log('🕐 Current timestamp:', {{ timestamp|default(0) }});
    initializeCostChart();
    initializeEgressInput();
    
    // Test calculation functionality
    window.testCalculation = function() {
        console.log('🧪 TEST: Starting calculation test');
        showCalculating();
        
        setTimeout(() => {
            console.log('🧪 TEST: Calculation complete - hiding loading');
            hideCalculating();
        }, 2000);
    };
    
    // Add event listeners
    document.getElementById('costCalculatorForm').addEventListener('submit', calculateCosts);
    document.getElementById('exportCSV').addEventListener('click', exportToCSV);
    document.getElementById('lambdaMemory').addEventListener('change', updateVMRecommendations);
    
    // Enable/disable instance type dropdowns based on checkbox state
    document.getElementById('compareEC2').addEventListener('change', function() {
        document.getElementById('ec2InstanceType').disabled = !this.checked;
    });
    document.getElementById('compareSakura').addEventListener('change', function() {
        document.getElementById('sakuraInstanceType').disabled = !this.checked;
    });
    document.getElementById('compareGCP').addEventListener('change', function() {
        document.getElementById('gcpInstanceType').disabled = !this.checked;
    });
    
    // Load available instances
    loadAvailableInstances();
    
    // Update recommendations
    updateVMRecommendations();
    
    // Initialize empty chart (don't calculate on page load)
    // calculateCosts(); // Removed: user should click Calculate button
    
    // Check API connectivity
    checkAPIConnectivity();
});

// Register custom plugin for execution rate reference lines and break-even points
const executionRateLinesPlugin = {
    id: 'executionRateLines',
    afterDraw: function(chart) {
        const ctx = chart.ctx;
        const chartArea = chart.chartArea;
        const xScale = chart.scales.x;
        const yScale = chart.scales.y;
        
        // Define execution rates (executions per second)
        const executionRates = [
            { perSecond: 0.001, label: '0.001/秒', color: 'rgba(255, 193, 7, 0.2)' },
            { perSecond: 0.01, label: '0.01/秒', color: 'rgba(255, 193, 7, 0.3)' },
            { perSecond: 0.1, label: '0.1/秒', color: 'rgba(255, 193, 7, 0.4)' },
            { perSecond: 1, label: '1/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 追加強調
            { perSecond: 2, label: '2/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 新規追加
            { perSecond: 5, label: '5/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 新規追加
            { perSecond: 10, label: '10/秒', color: 'rgba(255, 193, 7, 0.9)', lineWidth: 3 },  // 強調
            { perSecond: 100, label: '100/秒', color: 'rgba(255, 193, 7, 0.9)', lineWidth: 3 }, // 強調
            { perSecond: 1000, label: '1000/秒', color: 'rgba(255, 193, 7, 0.6)' },
            { perSecond: 10000, label: '10000/秒', color: 'rgba(255, 193, 7, 0.5)' }
        ];
        
        ctx.save();
        
        // Draw yellow reference lines
        executionRates.forEach(rate => {
            // Convert per-second to per-month (30 days * 24 hours * 3600 seconds)
            const perMonth = rate.perSecond * 30 * 24 * 3600;
            
            // Get pixel position for this execution count
            const xPixel = xScale.getPixelForValue(perMonth);
            
            // Only draw if within chart area
            if (xPixel >= chartArea.left && xPixel <= chartArea.right) {
                // Draw vertical line
                ctx.strokeStyle = rate.color;
                ctx.lineWidth = rate.lineWidth || 2;  // Use custom line width if specified
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(xPixel, chartArea.top);
                ctx.lineTo(xPixel, chartArea.bottom);
                ctx.stroke();
                
                // Draw label with different styling for emphasized lines
                if (rate.perSecond === 10 || rate.perSecond === 100) {
                    ctx.fillStyle = 'rgba(255, 193, 7, 1)';  // Full opacity for 10/秒 and 100/秒
                    ctx.font = 'bold 14px Arial';  // Bold and larger font
                } else if (rate.perSecond === 1 || rate.perSecond === 2 || rate.perSecond === 5) {
                    ctx.fillStyle = 'rgba(255, 193, 7, 0.95)';  // High opacity for 1/秒, 2/秒, 5/秒
                    ctx.font = 'bold 13px Arial';  // Bold medium font
                } else {
                    ctx.fillStyle = 'rgba(255, 193, 7, 0.8)';
                    ctx.font = '12px Arial';
                }
                ctx.textAlign = 'center';
                ctx.fillText(rate.label, xPixel, chartArea.top - 5);
            }
        });
        
        // Draw purple break-even lines
        if (window.lastBreakEvenData && window.lastBreakEvenData.length > 0) {
            ctx.save();
            
            window.lastBreakEvenData.forEach((breakEven, index) => {
                const executionsPerMonth = breakEven.executions_per_month;
                const executionsPerSecond = breakEven.executions_per_second;
                
                // Get pixel position for this execution count
                const xPixel = xScale.getPixelForValue(executionsPerMonth);
                
                // Only draw if within chart area
                if (xPixel >= chartArea.left && xPixel <= chartArea.right) {
                    // Draw vertical line
                    ctx.strokeStyle = 'rgba(128, 0, 128, 0.8)';  // Purple color
                    ctx.lineWidth = 3;
                    ctx.setLineDash([10, 5]);  // Longer dash pattern
                    ctx.beginPath();
                    ctx.moveTo(xPixel, chartArea.top);
                    ctx.lineTo(xPixel, chartArea.bottom);
                    ctx.stroke();
                    
                    // Draw arrow pointing down
                    ctx.fillStyle = 'rgba(128, 0, 128, 0.8)';
                    ctx.beginPath();
                    ctx.moveTo(xPixel, chartArea.bottom - 10);
                    ctx.lineTo(xPixel - 5, chartArea.bottom - 20);
                    ctx.lineTo(xPixel + 5, chartArea.bottom - 20);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Draw label on X-axis
                    ctx.fillStyle = 'rgba(128, 0, 128, 1)';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    
                    // Format executions per second
                    let label = '';
                    if (executionsPerSecond < 1) {
                        label = `${(executionsPerSecond).toFixed(2)}/秒`;
                    } else if (executionsPerSecond < 10) {
                        label = `${(executionsPerSecond).toFixed(1)}/秒`;
                    } else {
                        label = `${Math.round(executionsPerSecond)}/秒`;
                    }
                    
                    // Add provider info (shortened)
                    const provider = breakEven.vm_provider === 'aws_ec2' ? 'EC2' : 'Sakura';
                    
                    // Draw label below X-axis
                    ctx.fillText(label, xPixel, chartArea.bottom + 15);
                    ctx.font = '10px Arial';
                    ctx.fillText(`(${provider})`, xPixel, chartArea.bottom + 28);
                }
            });
            
            ctx.restore();
        }
        
        ctx.restore();
    }
};

// Register the plugin
Chart.register(executionRateLinesPlugin);

// Initialize egress input handling
function initializeEgressInput() {
    const egressPreset = document.getElementById('egressPreset');
    const egressCustom = document.getElementById('egressCustom');
    const egressError = document.getElementById('egressError');
    
    // Handle preset/custom toggle
    egressPreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            egressCustom.style.display = 'block';
            egressCustom.required = true;
            egressCustom.focus();
        } else {
            egressCustom.style.display = 'none';
            egressCustom.required = false;
            egressCustom.value = '';
            validateEgressInput();
        }
    });
    
    // Validate custom egress input
    egressCustom.addEventListener('input', validateEgressInput);
    egressCustom.addEventListener('blur', validateEgressInput);
    
    function validateEgressInput() {
        const value = parseFloat(egressCustom.value);
        const isCustomMode = egressPreset.value === 'custom';
        const isValid = !isCustomMode || (!isNaN(value) && value >= 0);
        
        if (isCustomMode && (!isValid || value < 0)) {
            egressError.style.display = 'block';
            egressCustom.classList.add('is-invalid');
            return false;
        } else {
            egressError.style.display = 'none';
            egressCustom.classList.remove('is-invalid');
            return true;
        }
    }
    
    // Expose validation function globally
    window.validateEgressInput = validateEgressInput;
    
    // Get current egress value function
    window.getEgressValue = function() {
        if (egressPreset.value === 'custom') {
            const value = parseFloat(egressCustom.value);
            return isNaN(value) ? 100 : Math.max(0, value); // Default to 100KB, minimum 0
        } else {
            return parseFloat(egressPreset.value);
        }
    };
    
    // Initialize egress rate customization
    const resetEgressRates = document.getElementById('resetEgressRates');
    
    // Reset to default rates
    resetEgressRates.addEventListener('click', function() {
        document.getElementById('awsEgressRate').value = '0.114';
        document.getElementById('gcpEgressRate').value = '0.12';
        document.getElementById('sakuraEgressRate').value = '0.0';
    });
    
    // Get current egress rates function
    window.getEgressRates = function() {
        return {
            aws_lambda: parseFloat(document.getElementById('awsEgressRate').value) || 0.114,
            aws_ec2: parseFloat(document.getElementById('awsEgressRate').value) || 0.114,
            google_cloud: parseFloat(document.getElementById('gcpEgressRate').value) || 0.12,
            sakura_cloud: parseFloat(document.getElementById('sakuraEgressRate').value) || 0.0
        };
    };
}

// Initialize Chart.js
function initializeCostChart() {
    const ctx = document.getElementById('costChart').getContext('2d');
    
    costChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'AWS Lambda',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'AWS EC2 (t3.small)',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: 'Sakura Cloud (2core/4GB)',
                    data: [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: 'Google Cloud (e2-micro)',
                    data: [],
                    borderColor: '#FFC107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    type: 'logarithmic',
                    title: {
                        display: true,
                        text: 'Monthly Executions'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Monthly Cost ($)'
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const formData = getFormData();
                            const exchangeRate = parseFloat(formData.exchangeRate);
                            const displayInJPY = formData.displayCurrency;
                            const currencySymbol = displayInJPY ? '¥' : '$';
                            
                            let value = context.parsed.y;
                            if (displayInJPY) {
                                value = value.toLocaleString('ja-JP', {maximumFractionDigits: 0});
                            } else {
                                value = value.toFixed(2);
                            }
                            
                            return context.dataset.label + ': ' + currencySymbol + value;
                        }
                    }
                }
            }
        }
    });
}

// Main calculation function
async function calculateCosts(event) {
    if (event) {
        event.preventDefault();
    }
    
    // Show simple loading indicator
    showCalculating();
    
    try {
        // Get form data
        const formData = getFormData();
        
        // Validate egress input before proceeding
        if (!window.validateEgressInput()) {
            hideCalculating();
            showError('Please enter a valid egress transfer amount');
            return;
        }

        // Call comparison API
        const requestData = {
            lambda_config: {
                memory_mb: parseInt(formData.lambdaMemory),
                execution_time_seconds: parseInt(formData.executionTime),
                include_free_tier: formData.includeFreeTier,
                egress_per_request_kb: window.getEgressValue()
            },
            vm_configs: getVMConfigs(formData),
            execution_range: {
                min: 1000000,  // 1M (1,000,000)
                max: 6000000,  // 6M (6 million)
                steps: 50
            },
            custom_egress_rates: window.getEgressRates(),
            include_egress_free_tier: formData.includeEgressFreeTier
        };
        
        console.log('🚀 Starting API request...');
        const startTime = Date.now();
        
        const response = await fetch('/api/v1/calculator/comparison', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        const endTime = Date.now();
        console.log(`✅ API request completed in ${endTime - startTime}ms`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('✅ API SUCCESS - Updating UI');
            
            comparisonData = result.data.comparison_data;
            lastBreakEvenData = result.data.break_even_points;
            updateChart(result.data);
            updateQuickResults(formData);
            updateDataTable(result.data);
            updateBreakEvenAnalysis(result.data.break_even_points);
        } else {
            showError(result.error || 'Calculation failed');
        }
        
    } catch (error) {
        console.error('Calculation error:', error);
        showError('Failed to connect to server. Please ensure the server is running.');
    } finally {
        // Always hide loading indicator
        hideCalculating();
    }
}

// Get form data
function getFormData() {
    const data = {
        lambdaMemory: document.getElementById('lambdaMemory').value,
        executionTime: document.getElementById('executionTime').value,
        executionFrequency: document.getElementById('executionFrequency').value,
        includeFreeTier: document.getElementById('includeFreeTier').checked,
        includeEgressFreeTier: document.getElementById('includeEgressFreeTier').checked,
        compareEC2: document.getElementById('compareEC2').checked,
        compareSakura: document.getElementById('compareSakura').checked,
        compareGCP: document.getElementById('compareGCP').checked,
        ec2InstanceType: document.getElementById('ec2InstanceType').value,
        sakuraInstanceType: document.getElementById('sakuraInstanceType').value,
        gcpInstanceType: document.getElementById('gcpInstanceType').value,
        exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
        displayCurrency: document.getElementById('displayCurrency').checked
    };
    
    // Validate required fields
    if (!data.lambdaMemory || !data.executionTime || !data.executionFrequency) {
        console.error('Missing required form fields:', data);
        throw new Error('Please fill in all required fields');
    }
    
    return data;
}

// Get VM configurations based on form selections
function getVMConfigs(formData) {
    const configs = [];
    
    if (formData.compareEC2) {
        configs.push({
            provider: 'aws_ec2',
            instance_type: formData.ec2InstanceType
        });
    }
    
    if (formData.compareSakura) {
        configs.push({
            provider: 'sakura_cloud',
            instance_type: formData.sakuraInstanceType
        });
    }
    
    if (formData.compareGCP) {
        configs.push({
            provider: 'google_cloud',
            instance_type: formData.gcpInstanceType
        });
    }
    
    return configs;
}

// Update chart with new data
function updateChart(data) {
    const labels = data.comparison_data.map(d => d.executions_per_month);
    const formData = getFormData();
    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    
    // Convert to JPY if needed
    const convertCurrency = (usdValue) => displayInJPY ? usdValue * exchangeRate : usdValue;
    
    const lambdaData = data.comparison_data.map(d => convertCurrency(d.lambda_cost_usd));
    
    // Get selected VM instance types
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
    
    const ec2Data = data.comparison_data.map(d => convertCurrency(d.vm_costs[ec2Key] || 0));
    const sakuraData = data.comparison_data.map(d => convertCurrency(d.vm_costs[sakuraKey] || 0));
    const gcpData = data.comparison_data.map(d => convertCurrency(d.vm_costs[gcpKey] || 0));
    
    // Update chart labels and Y-axis
    const currencySymbol = displayInJPY ? '¥' : '$';
    costChart.data.datasets[1].label = `AWS EC2 (${formData.ec2InstanceType})`;
    costChart.data.datasets[2].label = `Sakura Cloud (${formData.sakuraInstanceType})`;
    costChart.data.datasets[3].label = `Google Cloud (${formData.gcpInstanceType})`;
    costChart.options.scales.y.title.text = `Monthly Cost (${currencySymbol})`;
    
    costChart.data.labels = labels;
    costChart.data.datasets[0].data = lambdaData;
    costChart.data.datasets[1].data = ec2Data;
    costChart.data.datasets[2].data = sakuraData;
    costChart.data.datasets[3].data = gcpData;
    
    costChart.update();
}

// Update quick results
function updateQuickResults(formData) {
    const executions = parseInt(formData.executionFrequency);
    const relevantData = comparisonData.find(d => d.executions_per_month >= executions);
    
    if (relevantData) {
        const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
        const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
        
        const exchangeRate = parseFloat(formData.exchangeRate);
        const displayInJPY = formData.displayCurrency;
        const currencySymbol = displayInJPY ? '¥' : '$';
        
        const formatCurrency = (usdValue) => {
            const value = displayInJPY ? usdValue * exchangeRate : usdValue;
            return displayInJPY ? value.toLocaleString('ja-JP', {maximumFractionDigits: 0}) : value.toFixed(2);
        };
        
        let html = `
            <div class="row g-2">
                <div class="col-12">
                    <small class="text-muted">Monthly cost for ${executions.toLocaleString()} executions:</small>
                </div>
                <div class="col-12">
                    <div class="text-primary fw-bold">Lambda: ${currencySymbol}${formatCurrency(relevantData.lambda_cost_usd)}</div>
                </div>
        `;
        
        if (formData.compareEC2) {
            html += `
                <div class="col-12">
                    <div class="text-success fw-bold">EC2: ${currencySymbol}${formatCurrency(relevantData.vm_costs[ec2Key] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareSakura) {
            html += `
                <div class="col-12">
                    <div class="text-warning fw-bold">Sakura: ${currencySymbol}${formatCurrency(relevantData.vm_costs[sakuraKey] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareGCP) {
            const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
            html += `
                <div class="col-12">
                    <div class="text-info fw-bold">Google Cloud: ${currencySymbol}${formatCurrency(relevantData.vm_costs[gcpKey] || 0)}</div>
                </div>
            `;
        }
        
        html += '</div>';
        document.getElementById('quickResults').innerHTML = html;
    }
}

// Update data table
function updateDataTable(data) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    
    const formData = getFormData();
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    
    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    const currencySymbol = displayInJPY ? '¥' : '$';
    
    const formatCurrency = (usdValue) => {
        const value = displayInJPY ? usdValue * exchangeRate : usdValue;
        return displayInJPY ? value.toLocaleString('ja-JP', {maximumFractionDigits: 0}) : value.toFixed(2);
    };
    
    // Show every 5th data point to avoid clutter
    const filteredData = data.comparison_data.filter((_, index) => index % 5 === 0);
    
    filteredData.forEach(row => {
        const ec2Cost = row.vm_costs[ec2Key] || 0;
        const sakuraCost = row.vm_costs[sakuraKey] || 0;
        const lowestVMCost = Math.min(
            formData.compareEC2 ? ec2Cost : Infinity,
            formData.compareSakura ? sakuraCost : Infinity
        );
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.executions_per_month.toLocaleString()}</td>
            <td>${currencySymbol}${formatCurrency(row.lambda_cost_usd)}</td>
            <td>${formData.compareEC2 ? currencySymbol + formatCurrency(ec2Cost) : 'N/A'}</td>
            <td>${formData.compareSakura ? currencySymbol + formatCurrency(sakuraCost) : 'N/A'}</td>
            <td>${row.lambda_cost_usd > lowestVMCost ? '🔴' : '🟢'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Handle currency setting changes
function handleCurrencyChange() {
    if (comparisonData.length > 0) {
        // Re-render existing data with new currency settings
        const formData = getFormData();
        updateChart({comparison_data: comparisonData});
        updateQuickResults(formData);
        updateDataTable({comparison_data: comparisonData});
    }
}

// Update break-even analysis
function updateBreakEvenAnalysis(breakEvenPoints) {
    let html = '';
    
    if (breakEvenPoints.length > 0) {
        html = '<div class="row g-3">';
        breakEvenPoints.forEach(point => {
            html += `
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-1">${point.vm_provider} ${point.vm_instance}</h6>
                            <p class="card-text mb-0">
                                <strong>${point.executions_per_month.toLocaleString()}</strong> executions/month<br>
                                <small class="text-muted">(${point.executions_per_second.toFixed(2)} exec/sec)</small>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    } else {
        html = '<p class="text-muted mb-0">No break-even points found in current range</p>';
    }
    
    document.getElementById('breakEvenAnalysis').innerHTML = html;
}

// Export to CSV
function exportToCSV() {
    if (comparisonData.length === 0) {
        showError('No data to export. Please calculate first.');
        return;
    }
    
    const formData = getFormData();
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    const currencySymbol = displayInJPY ? 'JPY' : 'USD';
    
    const formatCurrency = (usdValue) => {
        const value = displayInJPY ? usdValue * exchangeRate : usdValue;
        return displayInJPY ? Math.round(value) : value.toFixed(2);
    };
    
    const now = new Date();
    const timestamp = now.toLocaleString('ja-JP');
    
    // CSV with metadata as per PBI #5 specification
    let csv = '\ufeff'; // UTF-8 BOM for Excel Japanese support
    csv += '"AWS Lambda vs VM Cost Comparison Report"\n';
    csv += `"Generated Date","${timestamp}"\n`;
    csv += `"Exchange Rate","${exchangeRate} JPY/USD"\n\n`;
    
    csv += '"Lambda Configuration"\n';
    csv += '"Memory (MB)","Execution Time (sec)","Monthly Executions"\n';
    csv += `"${formData.lambdaMemory}","${formData.executionDuration}","${formData.executionFrequency}"\n\n`;
    
    csv += '"Cost Comparison"\n';
    csv += `"Executions/Month","Lambda Cost (${currencySymbol})"`;
    if (formData.compareEC2) csv += `,"EC2 ${formData.ec2InstanceType} (${currencySymbol})"`;
    if (formData.compareSakura) csv += `,"Sakura ${formData.sakuraInstanceType} (${currencySymbol})"`;
    csv += '\n';
    
    comparisonData.forEach(row => {
        csv += `"${row.executions_per_month}","${formatCurrency(row.lambda_cost_usd)}"`;
        if (formData.compareEC2) csv += `,"${formatCurrency(row.vm_costs[ec2Key] || 0)}"`;
        if (formData.compareSakura) csv += `,"${formatCurrency(row.vm_costs[sakuraKey] || 0)}"`;
        csv += '\n';
    });
    
    // Add break-even points if available
    if (lastBreakEvenData && lastBreakEvenData.length > 0) {
        csv += '\n"Break-even Points"\n';
        csv += '"Service","Executions/Month","Executions/Second"\n';
        lastBreakEvenData.forEach(point => {
            csv += `"${point.vm_provider} ${point.vm_instance}","${point.executions_per_month}","${point.executions_per_second.toFixed(2)}"\n`;
        });
    }
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cost_comparison_${now.toISOString().split('T')[0].replace(/-/g, '')}_${now.toTimeString().slice(0,8).replace(/:/g, '')}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Check API connectivity
async function checkAPIConnectivity() {
    try {
        console.log('Checking API connectivity...');
        const response = await fetch('/api/v1/calculator/instances', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            console.log('✅ API is connected and responding');
        } else {
            console.warn('⚠️ API responded with status:', response.status);
            showError('API connection issue. Please refresh the page.');
        }
    } catch (error) {
        console.error('❌ API connectivity check failed:', error);
        showError('Unable to connect to API. Please check if the server is running.');
    }
}

// Load available instances from API
async function loadAvailableInstances() {
    try {
        const response = await fetch('/api/v1/calculator/instances');
        const result = await response.json();
        
        if (result.success) {
            // Instances are already populated in the HTML
            // This could be enhanced to dynamically populate dropdowns from API
            console.log('✅ Available instances loaded');
        }
    } catch (error) {
        console.error('Failed to load instances:', error);
    }
}

// Update VM recommendations based on Lambda memory
async function updateVMRecommendations() {
    const lambdaMemory = parseInt(document.getElementById('lambdaMemory').value);
    
    try {
        const response = await fetch('/api/v1/calculator/recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lambda_memory_mb: lambdaMemory
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
            let recommendationText = '';
            
            // EC2 recommendations
            if (result.data.aws_ec2 && result.data.aws_ec2.length > 0) {
                const ec2Rec = result.data.aws_ec2[0];
                recommendationText += `EC2: ${ec2Rec.instance_type} `;
            }
            
            // Google Cloud recommendations
            if (result.data.google_cloud && result.data.google_cloud.length > 0) {
                const gcpRec = result.data.google_cloud[0];
                if (recommendationText) recommendationText += '| ';
                recommendationText += `GCP: ${gcpRec.instance_type} `;
            }
            
            // Sakura recommendations
            if (result.data.sakura_cloud && result.data.sakura_cloud.length > 0) {
                const sakuraRec = result.data.sakura_cloud[0];
                if (recommendationText) recommendationText += '| ';
                recommendationText += `Sakura: ${sakuraRec.instance_type}`;
            }
            
            document.getElementById('vmRecommendations').textContent = recommendationText || 'No recommendations available';
        }
    } catch (error) {
        console.error('Failed to get recommendations:', error);
        document.getElementById('vmRecommendations').textContent = 'Unable to load recommendations';
    }
}

// Show error message
function showError(message) {
    const errorTemplate = document.getElementById('errorTemplate');
    const errorClone = errorTemplate.cloneNode(true);
    errorClone.id = '';
    errorClone.classList.remove('d-none');
    errorClone.querySelector('#errorMessage').textContent = message;
    
    document.querySelector('main').insertBefore(errorClone, document.querySelector('main').firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorClone.remove();
    }, 5000);
}
</script>
{% endblock %}