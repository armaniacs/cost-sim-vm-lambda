{% extends "base.html" %}

{% block title %}AWS Lambda vs VM Cost Simulator{% endblock %}

{% block content %}
<div class="row">
    <!-- Input Panel -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-gear me-2"></i><span data-i18n="sections.configuration">Configuration</span></h5>
            </div>
            <div class="card-body">
                <!-- Quick Calculate Button at Top -->
                <div class="d-grid gap-2 mb-4">
                    <button type="button" class="btn btn-primary btn-lg" onclick="calculateCosts()">
                        <i class="bi bi-calculator me-2"></i><span data-i18n="ui.buttons.calculate">Calculate</span>
                    </button>
                </div>
                
                <!-- Lambda Configuration -->
                <form id="costCalculatorForm">
                    <div class="mb-4">
                        <h6 class="fw-bold text-primary mb-3">
                            <i class="bi bi-cloud me-2"></i><span data-i18n="lambda.section_title">AWS Lambda Configuration</span>
                        </h6>
                        
                        <div class="mb-3">
                            <label for="lambdaMemory" class="form-label" data-i18n="lambda.memory_size">Memory Size</label>
                            <div class="input-group">
                                <select id="lambdaMemoryPreset" class="form-select">
                                    <option value="128">128 MB</option>
                                    <option value="512" selected>512 MB</option>
                                    <option value="1024">1024 MB</option>
                                    <option value="2048">2048 MB</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="lambdaMemoryCustom" class="form-control" 
                                       data-i18n-placeholder="lambda.placeholders.memory_mb" placeholder="Enter MB" 
                                       min="128" max="10240" step="1" value="512" required>
                                <span class="input-group-text">MB</span>
                            </div>
                            <div class="form-text" data-i18n="lambda.memory_description">
                                Lambda memory allocation (128MB to 10,240MB)
                            </div>
                            <div id="lambdaMemoryError" class="invalid-feedback" style="display: none;" data-i18n="validation.memory_range">
                                Memory size must be between 128 and 10,240 MB
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="executionTime" class="form-label" data-i18n="lambda.execution_time">Execution Time</label>
                            <div class="input-group">
                                <select id="executionTimePreset" class="form-select">
                                    <option value="1" selected>1 second</option>
                                    <option value="10">10 seconds</option>
                                    <option value="30">30 seconds</option>
                                    <option value="60">60 seconds</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="executionTimeCustom" class="form-control" 
                                       data-i18n-placeholder="lambda.placeholders.execution_seconds" placeholder="Enter seconds" 
                                       min="0.1" max="900" step="0.1" value="1" required>
                                <span class="input-group-text">seconds</span>
                            </div>
                            <div class="form-text" data-i18n="lambda.execution_time_description">
                                Lambda execution time (max 15 minutes = 900 seconds)
                            </div>
                            <div id="executionTimeError" class="invalid-feedback" style="display: none;" data-i18n="validation.execution_time_range">
                                Execution time must be between 0.1 and 900 seconds
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="executionFrequency" class="form-label" data-i18n="lambda.execution_frequency">Execution Frequency</label>
                            <div class="input-group">
                                <select id="executionFrequencyPreset" class="form-select">
                                    <option value="1000000">1M/month</option>
                                    <option value="2592000" selected>1/second (~2.59M/month)</option>
                                    <option value="25920000">10/second (~25.9M/month)</option>
                                    <option value="259200000">100/second (~259M/month)</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="executionFrequencyCustom" class="form-control" 
                                       data-i18n-placeholder="lambda.placeholders.execution_count" placeholder="Enter executions" 
                                       min="1" max="1000000000" step="1" value="2592000" required>
                                <span class="input-group-text">per month</span>
                            </div>
                            <div class="form-text" data-i18n="lambda.execution_frequency_description">
                                Monthly execution count (1 to 1 billion)
                            </div>
                            <div id="executionFrequencyError" class="invalid-feedback" style="display: none;" data-i18n="validation.execution_frequency_range">
                                Execution frequency must be between 1 and 1,000,000,000 per month
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="egressTransfer" class="form-label">
                                <i class="bi bi-cloud-arrow-up me-1"></i><span data-i18n="egress.title">Egress Transfer per Request</span>
                            </label>
                            <div class="input-group">
                                <select id="egressPreset" class="form-select">
                                    <option value="10">10 KB</option>
                                    <option value="100" selected>100 KB</option>
                                    <option value="1000">1 MB</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="egressCustom" class="form-control" 
                                       data-i18n-placeholder="egress.placeholder" placeholder="Enter KB" 
                                       min="0" max="10000000" step="0.1" value="100">
                                <span class="input-group-text">KB</span>
                            </div>
                            <div class="form-text" data-i18n="egress.description">
                                Amount of data transferred from Lambda/VM to internet per request
                            </div>
                            <div id="egressError" class="invalid-feedback" style="display: none;" data-i18n="validation.transfer_positive">
                                Transfer amount must be 0 or positive
                            </div>
                        </div>

                        <!-- Internet Transfer Ratio Configuration (PBI10) -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-globe me-1"></i><span data-i18n="transfer_ratio.title">Internet Transfer Ratio</span>
                            </label>
                            <div class="row g-2 align-items-center">
                                <div class="col-8">
                                    <div class="btn-group w-100" role="group" aria-label="Transfer ratio presets">
                                        <input type="radio" class="btn-check" name="transferRatioPreset" id="ratio0" value="0">
                                        <label class="btn btn-outline-primary btn-sm" for="ratio0">0%</label>
                                        
                                        <input type="radio" class="btn-check" name="transferRatioPreset" id="ratio10" value="10">
                                        <label class="btn btn-outline-primary btn-sm" for="ratio10">10%</label>
                                        
                                        <input type="radio" class="btn-check" name="transferRatioPreset" id="ratio50" value="50">
                                        <label class="btn btn-outline-primary btn-sm" for="ratio50">50%</label>
                                        
                                        <input type="radio" class="btn-check" name="transferRatioPreset" id="ratio100" value="100" checked>
                                        <label class="btn btn-outline-primary btn-sm" for="ratio100">100%</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="transferRatioCustom" class="form-control" 
                                               data-i18n-placeholder="transfer_ratio.placeholder" placeholder="Custom" 
                                               min="0" max="100" step="0.1">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-text" data-i18n="transfer_ratio.description">
                                Percentage of traffic that goes to the internet. 0% = fully private network, 100% = all traffic to internet
                            </div>
                            <div id="transferRatioError" class="invalid-feedback" style="display: none;" data-i18n="validation.transfer_ratio_range">
                                Transfer ratio must be between 0-100%
                            </div>
                        </div>

                        <!-- Egress Rate Customization -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-gear me-1"></i><span data-i18n="egress_rates.title">Egress Rates (USD/GB)</span>
                            </label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label for="awsEgressRate" class="form-label text-muted small" data-i18n="egress_rates.labels.aws">AWS Lambda/EC2</label>
                                    <input type="number" id="awsEgressRate" class="form-control form-control-sm" 
                                           value="0.114" min="0" step="0.001" placeholder="0.114">
                                </div>
                                <div class="col-md-6">
                                    <label for="gcpEgressRate" class="form-label text-muted small" data-i18n="egress_rates.labels.gcp">Google Cloud</label>
                                    <input type="number" id="gcpEgressRate" class="form-control form-control-sm" 
                                           value="0.12" min="0" step="0.001" placeholder="0.12">
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-6">
                                    <label for="azureEgressRate" class="form-label text-muted small" data-i18n="egress_rates.labels.azure">Azure</label>
                                    <input type="number" id="azureEgressRate" class="form-control form-control-sm" 
                                           value="0.12" min="0" step="0.001" placeholder="0.12">
                                </div>
                                <div class="col-md-6">
                                    <label for="ociEgressRate" class="form-label text-muted small" data-i18n="egress_rates.labels.oci">OCI</label>
                                    <input type="number" id="ociEgressRate" class="form-control form-control-sm" 
                                           value="0.025" min="0" step="0.001" placeholder="0.025">
                                </div>
                            </div>
                            <div class="row g-2 mt-1">
                                <div class="col-md-6">
                                    <label for="sakuraEgressRate" class="form-label text-muted small" data-i18n="egress_rates.labels.sakura">Sakura Cloud (JPY/GB)</label>
                                    <input type="number" id="sakuraEgressRate" class="form-control form-control-sm" 
                                           value="0.0" min="0" step="0.001" placeholder="0.0">
                                </div>
                                <div class="col-md-6 d-flex align-items-end">
                                    <button type="button" id="resetEgressRates" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="ui.buttons.reset_default">Reset to Default</span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-text">
                                Customize egress pricing rates. Defaults: AWS 0.114, GCP 0.12, Azure 0.12, OCI 0.025, Sakura 0.0 (free)
                            </div>
                        </div>

                        <!-- Egress Free Tier Toggle -->
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeEgressFreeTier">
                            <label class="form-check-label" for="includeEgressFreeTier">
                                <i class="bi bi-cloud-arrow-up me-1"></i>Include free egress tier (AWS, Google Cloud, Azure, OCI)
                            </label>
                            <div class="form-text">
                                AWS, Google Cloud, Azure provide 100GB/month, OCI provides 10TB/month of free internet egress transfer
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="includeFreeTier" checked>
                            <label class="form-check-label" for="includeFreeTier">
                                Include AWS Free Tier
                            </label>
                        </div>
                    </div>

                    <!-- VM Configuration -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="bi bi-server me-2"></i><span data-i18n="vm_comparison.title">VM Comparison</span>
                        </h6>
                        
                        <!-- EC2 Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareEC2" checked>
                                <label class="form-check-label" for="compareEC2" data-i18n="vm_comparison.providers.aws_ec2">
                                    AWS EC2
                                </label>
                            </div>
                            <select id="ec2InstanceType" class="form-select form-select-sm">
                                <option value="t3.micro" selected>t3.micro (1 GB, $9.79/month)</option>
                                <option value="t3.small">t3.small (2 GB, $19.58/month)</option>
                                <option value="t3.medium">t3.medium (4 GB, $39.17/month)</option>
                                <option value="t3.large">t3.large (8 GB, $79.42/month)</option>
                                <option value="c5.large">c5.large (4 GB, $69.12/month)</option>
                                <option value="c5.xlarge">c5.xlarge (8 GB, $140.16/month)</option>
                            </select>
                        </div>

                        <!-- Sakura Cloud Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareSakura" checked>
                                <label class="form-check-label" for="compareSakura" data-i18n="vm_comparison.providers.sakura_cloud">
                                    Sakura Cloud
                                </label>
                            </div>
                            <select id="sakuraInstanceType" class="form-select form-select-sm">
                                <option value="1core_1gb" selected>1 core/1 GB (¥1,595/month)</option>
                                <option value="2core_2gb">2 core/2 GB (¥3,190/month)</option>
                                <option value="2core_4gb">2 core/4 GB (¥4,180/month)</option>
                                <option value="4core_8gb">4 core/8 GB (¥7,370/month)</option>
                                <option value="6core_12gb">6 core/12 GB (¥11,560/month)</option>
                            </select>
                        </div>

                        <!-- Google Cloud Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareGCP" checked>
                                <label class="form-check-label" for="compareGCP" data-i18n="vm_comparison.providers.google_cloud">
                                    Google Cloud
                                </label>
                            </div>
                            <select id="gcpInstanceType" class="form-select form-select-sm">
                                <option value="e2-micro" selected>e2-micro (0.25 vCPU, 1GB)</option>
                                <option value="e2-small">e2-small (0.5 vCPU, 2GB)</option>
                                <option value="e2-medium">e2-medium (1 vCPU, 4GB)</option>
                                <option value="n2-standard-1">n2-standard-1 (1 vCPU, 4GB)</option>
                                <option value="n2-standard-2">n2-standard-2 (2 vCPU, 8GB)</option>
                                <option value="c2-standard-4">c2-standard-4 (4 vCPU, 16GB)</option>
                            </select>
                        </div>

                        <!-- Azure Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareAzure" checked>
                                <label class="form-check-label" for="compareAzure" data-i18n="vm_comparison.providers.azure">
                                    Azure
                                </label>
                            </div>
                            <select id="azureInstanceType" class="form-select form-select-sm">
                                <option value="B1ls" selected>B1ls (1 vCPU, 0.5GB, $6.72/month)</option>
                                <option value="B1s">B1s (1 vCPU, 1GB, $7.59/month)</option>
                                <option value="B1ms">B1ms (1 vCPU, 2GB, $15.18/month)</option>
                                <option value="B2s">B2s (2 vCPU, 4GB, $30.37/month)</option>
                                <option value="B2ms">B2ms (2 vCPU, 8GB, $60.74/month)</option>
                                <option value="A1_Basic">A1 Basic (1 vCPU, 1.75GB, $11.68/month)</option>
                                <option value="D3">D3 (4 vCPU, 14GB, $224.84/month)</option>
                                <option value="D4">D4 (8 vCPU, 28GB, $450.08/month)</option>
                            </select>
                        </div>

                        <!-- OCI Configuration -->
                        <div class="mb-3">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="compareOCI" checked>
                                <label class="form-check-label" for="compareOCI" data-i18n="vm_comparison.providers.oci">
                                    Oracle Cloud Infrastructure (OCI)
                                </label>
                            </div>
                            <select id="ociInstanceType" class="form-select form-select-sm">
                                <option value="VM.Standard.E2.1.Micro_Free">VM.Standard.E2.1.Micro (Always Free) (1 vCPU, 1GB, $0.00/month)</option>
                                <option value="VM.Standard.A1.Flex_Free">VM.Standard.A1.Flex (Always Free) (4 vCPU, 24GB, $0.00/month)</option>
                                <option value="VM.Standard.E2.1.Micro" selected>VM.Standard.E2.1.Micro (1 vCPU, 1GB, $3.65/month)</option>
                                <option value="VM.Standard.A1.Flex_1_6">VM.Standard.A1.Flex (1 vCPU, 6GB, $10.95/month)</option>
                                <option value="VM.Standard.E4.Flex_1_8">VM.Standard.E4.Flex (1 vCPU, 8GB, $18.25/month)</option>
                                <option value="VM.Standard.A1.Flex_2_12">VM.Standard.A1.Flex (2 vCPU, 12GB, $21.90/month)</option>
                                <option value="VM.Standard.E4.Flex_2_16">VM.Standard.E4.Flex (2 vCPU, 16GB, $35.77/month)</option>
                            </select>
                        </div>

                        <!-- Lambda Equivalent Recommendation -->
                        <div class="alert alert-info py-2 px-3 mb-0">
                            <small class="d-block mb-1"><i class="bi bi-info-circle me-1"></i><span data-i18n="vm_comparison.lambda_recommendations">Lambda Equivalent Recommendations:</span></small>
                            <small id="vmRecommendations" class="text-muted" data-i18n="ui.messages.select_lambda">Select Lambda memory to see recommendations</small>
                        </div>
                    </div>

                    <!-- Currency Settings -->
                    <div class="mb-4">
                        <h6 class="fw-bold text-warning mb-3">
                            <i class="bi bi-currency-yen me-2"></i><span data-i18n="currency.title">Currency Settings</span>
                        </h6>
                        
                        <div class="mb-3">
                            <label for="exchangeRate" class="form-label" data-i18n="currency.exchange_rate">Exchange Rate (JPY/USD)</label>
                            <div class="input-group">
                                <select id="exchangeRatePreset" class="form-select">
                                    <option value="140">140 JPY/USD</option>
                                    <option value="150" selected>150 JPY/USD</option>
                                    <option value="160">160 JPY/USD</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="number" id="exchangeRateCustom" class="form-control" 
                                       data-i18n-placeholder="currency.placeholder" placeholder="Enter rate" 
                                       min="100" max="300" step="0.1" value="150" required>
                                <span class="input-group-text">JPY/USD</span>
                            </div>
                            <div class="form-text" data-i18n="currency.exchange_rate_description">
                                Exchange rate for JPY/USD conversion (100-300 range)
                            </div>
                            <div id="exchangeRateError" class="invalid-feedback" style="display: none;" data-i18n="validation.exchange_rate_range">
                                Exchange rate must be between 100 and 300 JPY/USD
                            </div>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="displayCurrency" onchange="handleCurrencyChange()">
                            <label class="form-check-label" for="displayCurrency">
                                Display in JPY
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-calculator me-2"></i><span data-i18n="ui.buttons.calculate">Calculate</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Results -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-speedometer me-2"></i><span data-i18n="sections.quick_results">Quick Results</span></h6>
            </div>
            <div class="card-body">
                <div id="quickResults">
                    <p class="text-muted mb-0" data-i18n="ui.messages.calculate_prompt">Configure and calculate to see results</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="col-lg-8">
        <!-- Graph -->
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i><span data-i18n="sections.cost_comparison_graph">Cost Comparison Graph</span></h5>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 400px;">
                    <canvas id="costChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">
                    <i class="bi bi-table me-2"></i><span data-i18n="sections.detailed_data">Detailed Data</span>
                    <button class="btn btn-sm btn-outline-light float-end" id="exportCSV">
                        <i class="bi bi-download me-1"></i><span data-i18n="ui.buttons.export_csv">Export CSV</span>
                    </button>
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm" id="dataTable">
                        <thead>
                            <tr>
                                <th data-i18n="table.headers.executions_month">Executions/Month</th>
                                <th data-i18n="table.headers.lambda_cost">Lambda Cost</th>
                                <th data-i18n="table.headers.ec2_cost">EC2 Cost</th>
                                <th data-i18n="table.headers.sakura_cost">Sakura Cost</th>
                                <th data-i18n="table.headers.gcp_cost">Google Cloud Cost</th>
                                <th data-i18n="table.headers.azure_cost">Azure Cost</th>
                                <th data-i18n="table.headers.oci_cost">OCI Cost</th>
                                <th data-i18n="table.headers.breakeven">Break-even</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" class="text-center text-muted" data-i18n="ui.messages.no_data">No data available</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Break-even Points -->
        <div class="card shadow-sm mt-3">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i><span data-i18n="sections.breakeven_analysis">Break-even Analysis</span></h6>
            </div>
            <div class="card-body" id="breakEvenAnalysis">
                <p class="text-muted mb-0" data-i18n="ui.messages.calculate_prompt">Calculate to see break-even points</p>
            </div>
        </div>
    </div>
</div>


<!-- Error Alert Template -->
<div id="errorTemplate" class="alert alert-danger alert-dismissible fade show d-none" role="alert">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <span id="errorMessage"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let costChart = null;
let comparisonData = [];
let lastBreakEvenData = [];

// Simple loading indicator using button state
function showCalculating() {
    const calculateBtn = document.querySelector('button[type="submit"]');
    calculateBtn.disabled = true;
    calculateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculating...';
}

function hideCalculating() {
    const calculateBtn = document.querySelector('button[type="submit"]');
    calculateBtn.disabled = false;
    calculateBtn.innerHTML = '<i class="bi bi-calculator me-2"></i>Calculate';
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page loaded - initializing cost calculator...');
    console.log('🕐 Current timestamp:', {{ timestamp|default(0) }});
    initializeCostChart();
    initializeLambdaMemoryInput();
    initializeExecutionTimeInput();
    initializeExecutionFrequencyInput();
    initializeEgressInput();
    initializeExchangeRateInput();
    
    // Test calculation functionality
    window.testCalculation = function() {
        console.log('🧪 TEST: Starting calculation test');
        showCalculating();
        
        setTimeout(() => {
            console.log('🧪 TEST: Calculation complete - hiding loading');
            hideCalculating();
        }, 2000);
    };
    
    // Add event listeners
    document.getElementById('costCalculatorForm').addEventListener('submit', calculateCosts);
    document.getElementById('exportCSV').addEventListener('click', exportToCSV);
    // Lambda memory change handler will be set up in initializeLambdaMemoryInput
    
    // Enable/disable instance type dropdowns based on checkbox state
    document.getElementById('compareEC2').addEventListener('change', function() {
        document.getElementById('ec2InstanceType').disabled = !this.checked;
    });
    document.getElementById('compareSakura').addEventListener('change', function() {
        document.getElementById('sakuraInstanceType').disabled = !this.checked;
    });
    document.getElementById('compareGCP').addEventListener('change', function() {
        document.getElementById('gcpInstanceType').disabled = !this.checked;
    });
    document.getElementById('compareAzure').addEventListener('change', function() {
        document.getElementById('azureInstanceType').disabled = !this.checked;
    });
    document.getElementById('compareOCI').addEventListener('change', function() {
        document.getElementById('ociInstanceType').disabled = !this.checked;
    });
    
    // Load available instances
    loadAvailableInstances();
    
    // Update recommendations
    updateVMRecommendations();
    
    // Initialize empty chart (don't calculate on page load)
    // calculateCosts(); // Removed: user should click Calculate button
    
    // Check API connectivity
    checkAPIConnectivity();
});

// Register custom plugin for execution rate reference lines and break-even points
const executionRateLinesPlugin = {
    id: 'executionRateLines',
    afterDraw: function(chart) {
        const ctx = chart.ctx;
        const chartArea = chart.chartArea;
        const xScale = chart.scales.x;
        const yScale = chart.scales.y;
        
        // Define execution rates (executions per second)
        const executionRates = [
            { perSecond: 0.001, label: '0.001/秒', color: 'rgba(255, 193, 7, 0.2)' },
            { perSecond: 0.01, label: '0.01/秒', color: 'rgba(255, 193, 7, 0.3)' },
            { perSecond: 0.1, label: '0.1/秒', color: 'rgba(255, 193, 7, 0.4)' },
            { perSecond: 1, label: '1/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 追加強調
            { perSecond: 2, label: '2/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 新規追加
            { perSecond: 5, label: '5/秒', color: 'rgba(255, 193, 7, 0.8)', lineWidth: 2.5 },    // 新規追加
            { perSecond: 10, label: '10/秒', color: 'rgba(255, 193, 7, 0.9)', lineWidth: 3 },  // 強調
            { perSecond: 100, label: '100/秒', color: 'rgba(255, 193, 7, 0.9)', lineWidth: 3 }, // 強調
            { perSecond: 1000, label: '1000/秒', color: 'rgba(255, 193, 7, 0.6)' },
            { perSecond: 10000, label: '10000/秒', color: 'rgba(255, 193, 7, 0.5)' }
        ];
        
        ctx.save();
        
        // Draw yellow reference lines
        executionRates.forEach(rate => {
            // Convert per-second to per-month (30 days * 24 hours * 3600 seconds)
            const perMonth = rate.perSecond * 30 * 24 * 3600;
            
            // Get pixel position for this execution count
            const xPixel = xScale.getPixelForValue(perMonth);
            
            // Only draw if within chart area
            if (xPixel >= chartArea.left && xPixel <= chartArea.right) {
                // Draw vertical line
                ctx.strokeStyle = rate.color;
                ctx.lineWidth = rate.lineWidth || 2;  // Use custom line width if specified
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(xPixel, chartArea.top);
                ctx.lineTo(xPixel, chartArea.bottom);
                ctx.stroke();
                
                // Draw label with different styling for emphasized lines
                if (rate.perSecond === 10 || rate.perSecond === 100) {
                    ctx.fillStyle = 'rgba(255, 193, 7, 1)';  // Full opacity for 10/秒 and 100/秒
                    ctx.font = 'bold 14px Arial';  // Bold and larger font
                } else if (rate.perSecond === 1 || rate.perSecond === 2 || rate.perSecond === 5) {
                    ctx.fillStyle = 'rgba(255, 193, 7, 0.95)';  // High opacity for 1/秒, 2/秒, 5/秒
                    ctx.font = 'bold 13px Arial';  // Bold medium font
                } else {
                    ctx.fillStyle = 'rgba(255, 193, 7, 0.8)';
                    ctx.font = '12px Arial';
                }
                ctx.textAlign = 'center';
                ctx.fillText(rate.label, xPixel, chartArea.top - 5);
            }
        });
        
        ctx.restore();
    }
};

// Register the plugin
Chart.register(executionRateLinesPlugin);

// Initialize lambda memory input handling
function initializeLambdaMemoryInput() {
    const lambdaMemoryPreset = document.getElementById('lambdaMemoryPreset');
    const lambdaMemoryCustom = document.getElementById('lambdaMemoryCustom');
    const lambdaMemoryError = document.getElementById('lambdaMemoryError');
    
    // Handle preset/custom toggle
    lambdaMemoryPreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Custom option selected - keep input visible and focused
            lambdaMemoryCustom.focus();
        } else {
            // Preset option selected - update custom input value
            lambdaMemoryCustom.value = this.value;
            validateLambdaMemoryInput();
        }
    });
    
    // Validate custom lambda memory input
    lambdaMemoryCustom.addEventListener('input', validateLambdaMemoryInput);
    lambdaMemoryCustom.addEventListener('blur', validateLambdaMemoryInput);
    
    // Add change handler for VM recommendations
    lambdaMemoryPreset.addEventListener('change', updateVMRecommendations);
    lambdaMemoryCustom.addEventListener('input', updateVMRecommendations);
    
    function validateLambdaMemoryInput() {
        const value = parseInt(lambdaMemoryCustom.value);
        const isValid = !isNaN(value) && value >= 128 && value <= 10240;
        
        if (!isValid) {
            lambdaMemoryError.style.display = 'block';
            lambdaMemoryCustom.classList.add('is-invalid');
        } else {
            lambdaMemoryError.style.display = 'none';
            lambdaMemoryCustom.classList.remove('is-invalid');
        }
        
        return isValid;
    }
    
    // Expose validation function globally
    window.validateLambdaMemoryInput = validateLambdaMemoryInput;
    
    // Get current lambda memory value function
    window.getLambdaMemoryValue = function() {
        // Always use the value from the custom input field
        const value = parseInt(lambdaMemoryCustom.value);
        return isNaN(value) ? 512 : Math.max(128, Math.min(10240, value)); // Default to 512MB, range 128-10240MB
    };
}

// Initialize execution time input handling
function initializeExecutionTimeInput() {
    const executionTimePreset = document.getElementById('executionTimePreset');
    const executionTimeCustom = document.getElementById('executionTimeCustom');
    const executionTimeError = document.getElementById('executionTimeError');
    
    // Handle preset/custom toggle
    executionTimePreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Custom option selected - keep input visible and focused
            executionTimeCustom.focus();
        } else {
            // Preset option selected - update custom input value
            executionTimeCustom.value = this.value;
            validateExecutionTimeInput();
        }
    });
    
    // Validate custom execution time input
    executionTimeCustom.addEventListener('input', validateExecutionTimeInput);
    executionTimeCustom.addEventListener('blur', validateExecutionTimeInput);
    
    function validateExecutionTimeInput() {
        const value = parseFloat(executionTimeCustom.value);
        const isValid = !isNaN(value) && value >= 0.1 && value <= 900;
        
        if (!isValid) {
            executionTimeError.style.display = 'block';
            executionTimeCustom.classList.add('is-invalid');
        } else {
            executionTimeError.style.display = 'none';
            executionTimeCustom.classList.remove('is-invalid');
        }
        
        return isValid;
    }
    
    // Expose validation function globally
    window.validateExecutionTimeInput = validateExecutionTimeInput;
    
    // Get current execution time value function
    window.getExecutionTimeValue = function() {
        // Always use the value from the custom input field
        const value = parseFloat(executionTimeCustom.value);
        return isNaN(value) ? 1 : Math.max(0.1, Math.min(900, value)); // Default to 1s, range 0.1-900s
    };
}

// Initialize execution frequency input handling
function initializeExecutionFrequencyInput() {
    const executionFrequencyPreset = document.getElementById('executionFrequencyPreset');
    const executionFrequencyCustom = document.getElementById('executionFrequencyCustom');
    const executionFrequencyError = document.getElementById('executionFrequencyError');
    
    // Handle preset/custom toggle
    executionFrequencyPreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Custom option selected - keep input visible and focused
            executionFrequencyCustom.focus();
        } else {
            // Preset option selected - update custom input value
            executionFrequencyCustom.value = this.value;
            validateExecutionFrequencyInput();
        }
    });
    
    // Validate custom execution frequency input
    executionFrequencyCustom.addEventListener('input', validateExecutionFrequencyInput);
    executionFrequencyCustom.addEventListener('blur', validateExecutionFrequencyInput);
    
    function validateExecutionFrequencyInput() {
        const value = parseInt(executionFrequencyCustom.value);
        const isValid = !isNaN(value) && value >= 1 && value <= 1000000000;
        
        if (!isValid) {
            executionFrequencyError.style.display = 'block';
            executionFrequencyCustom.classList.add('is-invalid');
        } else {
            executionFrequencyError.style.display = 'none';
            executionFrequencyCustom.classList.remove('is-invalid');
        }
        
        return isValid;
    }
    
    // Expose validation function globally
    window.validateExecutionFrequencyInput = validateExecutionFrequencyInput;
    
    // Get current execution frequency value function
    window.getExecutionFrequencyValue = function() {
        // Always use the value from the custom input field
        const value = parseInt(executionFrequencyCustom.value);
        return isNaN(value) ? 2592000 : Math.max(1, Math.min(1000000000, value)); // Default to 1/second (~2.59M), range 1-1B
    };
}

// Initialize exchange rate input handling
function initializeExchangeRateInput() {
    const exchangeRatePreset = document.getElementById('exchangeRatePreset');
    const exchangeRateCustom = document.getElementById('exchangeRateCustom');
    const exchangeRateError = document.getElementById('exchangeRateError');
    
    // Handle preset/custom toggle
    exchangeRatePreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Custom option selected - keep input visible and focused
            exchangeRateCustom.focus();
        } else {
            // Preset option selected - update custom input value
            exchangeRateCustom.value = this.value;
            validateExchangeRateInput();
            handleCurrencyChange(); // Trigger currency change handler
        }
    });
    
    // Validate custom exchange rate input
    exchangeRateCustom.addEventListener('input', function() {
        validateExchangeRateInput();
        handleCurrencyChange(); // Trigger currency change handler
    });
    exchangeRateCustom.addEventListener('blur', validateExchangeRateInput);
    
    function validateExchangeRateInput() {
        const value = parseFloat(exchangeRateCustom.value);
        const isValid = !isNaN(value) && value >= 100 && value <= 300;
        
        if (!isValid) {
            exchangeRateError.style.display = 'block';
            exchangeRateCustom.classList.add('is-invalid');
        } else {
            exchangeRateError.style.display = 'none';
            exchangeRateCustom.classList.remove('is-invalid');
        }
        
        return isValid;
    }
    
    // Expose validation function globally
    window.validateExchangeRateInput = validateExchangeRateInput;
    
    // Get current exchange rate value function
    window.getExchangeRateValue = function() {
        // Always use the value from the custom input field
        const value = parseFloat(exchangeRateCustom.value);
        return isNaN(value) ? 150 : Math.max(100, Math.min(300, value)); // Default to 150, range 100-300
    };
}

// Initialize egress input handling
function initializeEgressInput() {
    const egressPreset = document.getElementById('egressPreset');
    const egressCustom = document.getElementById('egressCustom');
    const egressError = document.getElementById('egressError');
    
    // Handle preset/custom toggle
    egressPreset.addEventListener('change', function() {
        if (this.value === 'custom') {
            // Custom option selected - keep input visible and focused
            egressCustom.focus();
        } else {
            // Preset option selected - update custom input value
            egressCustom.value = this.value;
            validateEgressInput();
        }
    });
    
    // Validate custom egress input
    egressCustom.addEventListener('input', validateEgressInput);
    egressCustom.addEventListener('blur', validateEgressInput);
    
    function validateEgressInput() {
        const value = parseFloat(egressCustom.value);
        const isCustomMode = egressPreset.value === 'custom';
        const isValid = !isCustomMode || (!isNaN(value) && value >= 0);
        
        if (isCustomMode && (!isValid || value < 0)) {
            egressError.style.display = 'block';
            egressCustom.classList.add('is-invalid');
            return false;
        } else {
            egressError.style.display = 'none';
            egressCustom.classList.remove('is-invalid');
            return true;
        }
    }
    
    // Expose validation function globally
    window.validateEgressInput = validateEgressInput;
    
    // Get current egress value function
    window.getEgressValue = function() {
        // Always use the value from the custom input field
        const value = parseFloat(egressCustom.value);
        return isNaN(value) ? 100 : Math.max(0, value); // Default to 100KB, minimum 0
    };
    
    // Initialize egress rate customization
    const resetEgressRates = document.getElementById('resetEgressRates');
    
    // Reset to default rates
    resetEgressRates.addEventListener('click', function() {
        document.getElementById('awsEgressRate').value = '0.114';
        document.getElementById('gcpEgressRate').value = '0.12';
        document.getElementById('azureEgressRate').value = '0.12';
        document.getElementById('ociEgressRate').value = '0.025';
        document.getElementById('sakuraEgressRate').value = '0.0';
    });

    // PBI10: Internet Transfer Ratio functionality
    const transferRatioPresets = document.querySelectorAll('input[name="transferRatioPreset"]');
    const transferRatioCustom = document.getElementById('transferRatioCustom');
    const transferRatioError = document.getElementById('transferRatioError');

    // Handle preset selection
    transferRatioPresets.forEach(preset => {
        preset.addEventListener('change', function() {
            if (this.checked) {
                transferRatioCustom.value = '';
                transferRatioError.style.display = 'none';
            }
        });
    });

    // Handle custom input
    transferRatioCustom.addEventListener('input', function() {
        // Clear preset selection when custom input is used
        transferRatioPresets.forEach(preset => preset.checked = false);
        
        // Validate input
        validateTransferRatio();
    });

    // Validation function for transfer ratio
    function validateTransferRatio() {
        const value = parseFloat(transferRatioCustom.value);
        
        if (transferRatioCustom.value !== '' && (isNaN(value) || value < 0 || value > 100)) {
            transferRatioError.style.display = 'block';
            transferRatioCustom.classList.add('is-invalid');
            return false;
        } else {
            transferRatioError.style.display = 'none';
            transferRatioCustom.classList.remove('is-invalid');
            return true;
        }
    }

    // Expose transfer ratio functions globally
    window.validateTransferRatio = validateTransferRatio;
    
    window.getInternetTransferRatio = function() {
        // Check if custom value is entered
        if (transferRatioCustom.value !== '') {
            const value = parseFloat(transferRatioCustom.value);
            return isNaN(value) ? 100 : Math.min(100, Math.max(0, value)); // Clamp between 0-100
        }
        
        // Check preset selection
        const selectedPreset = document.querySelector('input[name="transferRatioPreset"]:checked');
        if (selectedPreset) {
            return parseFloat(selectedPreset.value);
        }
        
        // Default to 100% if nothing selected
        return 100;
    };
    
    // Get current egress rates function
    window.getEgressRates = function() {
        return {
            aws_lambda: parseFloat(document.getElementById('awsEgressRate').value) || 0.114,
            aws_ec2: parseFloat(document.getElementById('awsEgressRate').value) || 0.114,
            google_cloud: parseFloat(document.getElementById('gcpEgressRate').value) || 0.12,
            azure: parseFloat(document.getElementById('azureEgressRate').value) || 0.12,
            oci: parseFloat(document.getElementById('ociEgressRate').value) || 0.025,
            sakura_cloud: parseFloat(document.getElementById('sakuraEgressRate').value) || 0.0
        };
    };
}

// Initialize Chart.js with i18n support
function initializeCostChart() {
    const ctx = document.getElementById('costChart').getContext('2d');
    
    // Get chart labels from i18n if available, otherwise use defaults
    const getChartLabels = () => {
        if (window.i18n && window.i18n.getCurrentLanguage) {
            return {
                title: window.i18n.t('chart.title'),
                xAxis: window.i18n.t('chart.x_axis'),
                yAxis: window.i18n.t('chart.y_axis'),
                legends: {
                    aws_lambda: window.i18n.t('chart.legend.aws_lambda'),
                    aws_ec2: window.i18n.t('chart.legend.aws_ec2'),
                    sakura_cloud: window.i18n.t('chart.legend.sakura_cloud'),
                    google_cloud: window.i18n.t('chart.legend.google_cloud'),
                    azure: window.i18n.t('chart.legend.azure'),
                    oci: window.i18n.t('chart.legend.oci')
                }
            };
        } else {
            // Fallback to English
            return {
                title: 'Cost Comparison Chart',
                xAxis: 'Monthly Executions',
                yAxis: 'Monthly Cost (USD)',
                legends: {
                    aws_lambda: 'AWS Lambda',
                    aws_ec2: 'AWS EC2',
                    sakura_cloud: 'Sakura Cloud',
                    google_cloud: 'Google Cloud',
                    azure: 'Azure',
                    oci: 'OCI'
                }
            };
        }
    };
    
    const chartLabels = getChartLabels();
    
    costChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: chartLabels.legends.aws_lambda,
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1
                },
                {
                    label: chartLabels.legends.aws_ec2 + ' (t3.small)',
                    data: [],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: chartLabels.legends.sakura_cloud + ' (2core/4GB)',
                    data: [],
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: chartLabels.legends.google_cloud + ' (e2-micro)',
                    data: [],
                    borderColor: '#FFC107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: chartLabels.legends.azure + ' (B2ms)',
                    data: [],
                    borderColor: '#0078D4',
                    backgroundColor: 'rgba(0, 120, 212, 0.1)',
                    borderDash: [5, 5]
                },
                {
                    label: chartLabels.legends.oci + ' (VM.Standard.E4.Flex_2_16)',
                    data: [],
                    borderColor: '#F80000',
                    backgroundColor: 'rgba(248, 0, 0, 0.1)',
                    borderDash: [5, 5]
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    type: 'logarithmic',
                    title: {
                        display: true,
                        text: chartLabels.xAxis
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: chartLabels.yAxis
                    },
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: chartLabels.title
                },
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const formData = getFormData();
                            const exchangeRate = parseFloat(formData.exchangeRate);
                            const displayInJPY = formData.displayCurrency;
                            const currencySymbol = displayInJPY ? '¥' : '$';
                            
                            let value = context.parsed.y;
                            if (displayInJPY) {
                                value = value.toLocaleString('ja-JP', {maximumFractionDigits: 0});
                            } else {
                                value = value.toFixed(2);
                            }
                            
                            return context.dataset.label + ': ' + currencySymbol + value;
                        }
                    }
                }
            }
        }
    });
}

// Main calculation function
async function calculateCosts(event) {
    if (event) {
        event.preventDefault();
    }
    
    // Show simple loading indicator
    showCalculating();
    
    try {
        // Get form data
        const formData = getFormData();
        
        // Validate egress input before proceeding
        if (!window.validateEgressInput()) {
            hideCalculating();
            showError('Please enter a valid egress transfer amount');
            return;
        }

        // Validate transfer ratio input before proceeding (PBI10)
        if (!window.validateTransferRatio()) {
            hideCalculating();
            showError('Please enter a valid internet transfer ratio (0-100%)');
            return;
        }

        // Call comparison API
        const requestData = {
            lambda_config: {
                memory_mb: parseInt(formData.lambdaMemory),
                execution_time_seconds: parseFloat(formData.executionTime),
                include_free_tier: formData.includeFreeTier,
                egress_per_request_kb: window.getEgressValue(),
                internet_transfer_ratio: formData.internetTransferRatio  // PBI10
            },
            vm_configs: getVMConfigs(formData),
            execution_range: {
                min: 1000000,  // 1M (1,000,000)
                max: Math.max(parseInt(formData.executionFrequency) * 3.0, 8000000),  // Extend data generation to cover full X-axis display
                steps: 50
            },
            custom_egress_rates: window.getEgressRates(),
            include_egress_free_tier: formData.includeEgressFreeTier
        };
        
        console.log('🚀 Starting API request...');
        const startTime = Date.now();
        
        const response = await fetch('/api/v1/calculator/comparison', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        const endTime = Date.now();
        console.log(`✅ API request completed in ${endTime - startTime}ms`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            console.log('✅ API SUCCESS - Updating UI');
            
            comparisonData = result.data.comparison_data;
            lastBreakEvenData = result.data.break_even_points;
            updateChart(result.data);
            updateQuickResults(formData);
            updateDataTable(result.data);
            updateBreakEvenAnalysis(result.data.break_even_points);
        } else {
            showError(result.error || 'Calculation failed');
        }
        
    } catch (error) {
        console.error('Calculation error:', error);
        showError('Failed to connect to server. Please ensure the server is running.');
    } finally {
        // Always hide loading indicator
        hideCalculating();
    }
}

// Get form data
function getFormData() {
    const data = {
        lambdaMemory: window.getLambdaMemoryValue(),
        executionTime: window.getExecutionTimeValue(),
        executionFrequency: window.getExecutionFrequencyValue(),
        includeFreeTier: document.getElementById('includeFreeTier').checked,
        includeEgressFreeTier: document.getElementById('includeEgressFreeTier').checked,
        compareEC2: document.getElementById('compareEC2').checked,
        compareSakura: document.getElementById('compareSakura').checked,
        compareGCP: document.getElementById('compareGCP').checked,
        compareAzure: document.getElementById('compareAzure').checked,
        compareOCI: document.getElementById('compareOCI').checked,
        ec2InstanceType: document.getElementById('ec2InstanceType').value,
        sakuraInstanceType: document.getElementById('sakuraInstanceType').value,
        gcpInstanceType: document.getElementById('gcpInstanceType').value,
        azureInstanceType: document.getElementById('azureInstanceType').value,
        ociInstanceType: document.getElementById('ociInstanceType').value,
        exchangeRate: window.getExchangeRateValue(),
        displayCurrency: document.getElementById('displayCurrency').checked,
        internetTransferRatio: window.getInternetTransferRatio()  // PBI10
    };
    
    // Validate required fields
    if (!data.lambdaMemory || !data.executionTime || !data.executionFrequency) {
        console.error('Missing required form fields:', data);
        throw new Error('Please fill in all required fields');
    }
    
    return data;
}

// Get VM configurations based on form selections
function getVMConfigs(formData) {
    const configs = [];
    
    if (formData.compareEC2) {
        configs.push({
            provider: 'aws_ec2',
            instance_type: formData.ec2InstanceType
        });
    }
    
    if (formData.compareSakura) {
        configs.push({
            provider: 'sakura_cloud',
            instance_type: formData.sakuraInstanceType
        });
    }
    
    if (formData.compareGCP) {
        configs.push({
            provider: 'google_cloud',
            instance_type: formData.gcpInstanceType
        });
    }
    
    if (formData.compareAzure) {
        configs.push({
            provider: 'azure',
            instance_type: formData.azureInstanceType
        });
    }
    
    if (formData.compareOCI) {
        configs.push({
            provider: 'oci',
            instance_type: formData.ociInstanceType
        });
    }
    
    return configs;
}

// Update chart with new data
function updateChart(data) {
    const labels = data.comparison_data.map(d => d.executions_per_month);
    const formData = getFormData();
    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    
    // Convert to JPY if needed
    const convertCurrency = (usdValue) => displayInJPY ? usdValue * exchangeRate : usdValue;
    
    const lambdaData = data.comparison_data.map(d => convertCurrency(d.lambda_cost_usd));
    
    // Get selected VM instance types
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
    const azureKey = `azure_${formData.azureInstanceType}`;
    const ociKey = `oci_${formData.ociInstanceType}`;
    
    const ec2Data = data.comparison_data.map(d => convertCurrency(d.vm_costs[ec2Key] || 0));
    const sakuraData = data.comparison_data.map(d => convertCurrency(d.vm_costs[sakuraKey] || 0));
    const gcpData = data.comparison_data.map(d => convertCurrency(d.vm_costs[gcpKey] || 0));
    const azureData = data.comparison_data.map(d => convertCurrency(d.vm_costs[azureKey] || 0));
    const ociData = data.comparison_data.map(d => convertCurrency(d.vm_costs[ociKey] || 0));
    
    // Update chart labels and Y-axis with i18n support
    const currencySymbol = displayInJPY ? '¥' : '$';
    const currencyLabel = displayInJPY ? '円' : 'USD';
    
    // Get chart legend labels from i18n if available
    const getChartLegends = () => {
        if (window.i18n && window.i18n.getCurrentLanguage) {
            return {
                aws_lambda: window.i18n.t('chart.legend.aws_lambda'),
                aws_ec2: window.i18n.t('chart.legend.aws_ec2'),
                sakura_cloud: window.i18n.t('chart.legend.sakura_cloud'),
                google_cloud: window.i18n.t('chart.legend.google_cloud'),
                azure: window.i18n.t('chart.legend.azure'),
                oci: window.i18n.t('chart.legend.oci'),
                y_axis: window.i18n.t('chart.y_axis')
            };
        } else {
            return {
                aws_lambda: 'AWS Lambda',
                aws_ec2: 'AWS EC2',
                sakura_cloud: 'Sakura Cloud',
                google_cloud: 'Google Cloud',
                azure: 'Azure',
                oci: 'OCI',
                y_axis: 'Monthly Cost'
            };
        }
    };
    
    const chartLegends = getChartLegends();
    
    costChart.data.datasets[0].label = chartLegends.aws_lambda;
    costChart.data.datasets[1].label = `${chartLegends.aws_ec2} (${formData.ec2InstanceType})`;
    costChart.data.datasets[2].label = `${chartLegends.sakura_cloud} (${formData.sakuraInstanceType})`;
    costChart.data.datasets[3].label = `${chartLegends.google_cloud} (${formData.gcpInstanceType})`;
    costChart.data.datasets[4].label = `${chartLegends.azure} (${formData.azureInstanceType})`;
    costChart.data.datasets[5].label = `${chartLegends.oci} (${formData.ociInstanceType})`;
    costChart.options.scales.y.title.text = `${chartLegends.y_axis} (${currencySymbol})`;
    
    costChart.data.labels = labels;
    costChart.data.datasets[0].data = lambdaData;
    costChart.data.datasets[1].data = ec2Data;
    costChart.data.datasets[2].data = sakuraData;
    costChart.data.datasets[3].data = gcpData;
    costChart.data.datasets[4].data = azureData;
    costChart.data.datasets[5].data = ociData;
    
    costChart.update();
}

// Update quick results
function updateQuickResults(formData) {
    const executions = parseInt(formData.executionFrequency);
    const relevantData = comparisonData.find(d => d.executions_per_month >= executions);
    
    if (relevantData) {
        const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
        const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
        const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
        const azureKey = `azure_${formData.azureInstanceType}`;
        const ociKey = `oci_${formData.ociInstanceType}`;
        
        const exchangeRate = parseFloat(formData.exchangeRate);
        const displayInJPY = formData.displayCurrency;
        const currencySymbol = displayInJPY ? '¥' : '$';
        
        const formatCurrency = (usdValue) => {
            const value = displayInJPY ? usdValue * exchangeRate : usdValue;
            return displayInJPY ? value.toLocaleString('ja-JP', {maximumFractionDigits: 0}) : value.toFixed(2);
        };
        
        let html = `
            <div class="row g-2">
                <div class="col-12">
                    <small class="text-muted">Monthly cost for ${executions.toLocaleString()} executions:</small>
                </div>
                <div class="col-12">
                    <div class="text-primary fw-bold">Lambda: ${currencySymbol}${formatCurrency(relevantData.lambda_cost_usd)}</div>
                </div>
        `;
        
        if (formData.compareEC2) {
            html += `
                <div class="col-12">
                    <div class="text-success fw-bold">EC2: ${currencySymbol}${formatCurrency(relevantData.vm_costs[ec2Key] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareSakura) {
            html += `
                <div class="col-12">
                    <div class="text-warning fw-bold">Sakura: ${currencySymbol}${formatCurrency(relevantData.vm_costs[sakuraKey] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareGCP) {
            html += `
                <div class="col-12">
                    <div class="text-info fw-bold">Google Cloud: ${currencySymbol}${formatCurrency(relevantData.vm_costs[gcpKey] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareAzure) {
            html += `
                <div class="col-12">
                    <div class="text-azure fw-bold">Azure: ${currencySymbol}${formatCurrency(relevantData.vm_costs[azureKey] || 0)}</div>
                </div>
            `;
        }
        
        if (formData.compareOCI) {
            html += `
                <div class="col-12">
                    <div class="text-oci fw-bold">OCI: ${currencySymbol}${formatCurrency(relevantData.vm_costs[ociKey] || 0)}</div>
                </div>
            `;
        }
        
        html += '</div>';
        document.getElementById('quickResults').innerHTML = html;
    }
}

// Update data table
function updateDataTable(data) {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    
    const formData = getFormData();
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
    const azureKey = `azure_${formData.azureInstanceType}`;
    const ociKey = `oci_${formData.ociInstanceType}`;
    
    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    const currencySymbol = displayInJPY ? '¥' : '$';
    
    const formatCurrency = (usdValue) => {
        const value = displayInJPY ? usdValue * exchangeRate : usdValue;
        return displayInJPY ? value.toLocaleString('ja-JP', {maximumFractionDigits: 0}) : value.toFixed(2);
    };
    
    // Show every 5th data point to avoid clutter
    const filteredData = data.comparison_data.filter((_, index) => index % 5 === 0);
    
    filteredData.forEach(row => {
        const ec2Cost = row.vm_costs[ec2Key] || 0;
        const sakuraCost = row.vm_costs[sakuraKey] || 0;
        const gcpCost = row.vm_costs[gcpKey] || 0;
        const azureCost = row.vm_costs[azureKey] || 0;
        const ociCost = row.vm_costs[ociKey] || 0;

        const vmCosts = [];
        if (formData.compareEC2) vmCosts.push(ec2Cost);
        if (formData.compareSakura) vmCosts.push(sakuraCost);
        if (formData.compareGCP) vmCosts.push(gcpCost);
        if (formData.compareAzure) vmCosts.push(azureCost);
        if (formData.compareOCI) vmCosts.push(ociCost);

        const lowestVMCost = vmCosts.length > 0 ? Math.min(...vmCosts) : Infinity;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.executions_per_month.toLocaleString()}</td>
            <td>${currencySymbol}${formatCurrency(row.lambda_cost_usd)}</td>
            <td>${formData.compareEC2 ? currencySymbol + formatCurrency(ec2Cost) : 'N/A'}</td>
            <td>${formData.compareSakura ? currencySymbol + formatCurrency(sakuraCost) : 'N/A'}</td>
            <td>${formData.compareGCP ? currencySymbol + formatCurrency(gcpCost) : 'N/A'}</td>
            <td>${formData.compareAzure ? currencySymbol + formatCurrency(azureCost) : 'N/A'}</td>
            <td>${formData.compareOCI ? currencySymbol + formatCurrency(ociCost) : 'N/A'}</td>
            <td>${row.lambda_cost_usd > lowestVMCost ? '🔴' : '🟢'}</td>
        `;
        tbody.appendChild(tr);
    });
}

// Handle currency setting changes
function handleCurrencyChange() {
    if (comparisonData.length > 0) {
        // Re-render existing data with new currency settings
        const formData = getFormData();
        updateChart({comparison_data: comparisonData});
        updateQuickResults(formData);
        updateDataTable({comparison_data: comparisonData});
    }
}

// Update break-even analysis
function updateBreakEvenAnalysis(breakEvenPoints) {
    let html = '';
    
    if (breakEvenPoints.length > 0) {
        html = '<div class="row g-3">';
        breakEvenPoints.forEach(point => {
            const providerMap = {
                'aws_ec2': 'EC2',
                'sakura_cloud': 'Sakura',
                'google_cloud': 'GCP',
                'azure': 'Azure',
                'oci': 'OCI'
            };
            const providerName = providerMap[point.vm_provider] || point.vm_provider;

            html += `
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-1">${providerName} ${point.vm_instance}</h6>
                            <p class="card-text mb-0">
                                <strong>${point.executions_per_month.toLocaleString()}</strong> executions/month<br>
                                <small class="text-muted">(${point.executions_per_second.toFixed(2)} exec/sec)</small>
                            </p>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    } else {
        html = '<p class="text-muted mb-0">No break-even points found in current range</p>';
    }
    
    document.getElementById('breakEvenAnalysis').innerHTML = html;
}

// Export to CSV with i18n support
function exportToCSV() {
    if (comparisonData.length === 0) {
        const errorMsg = window.i18n ? window.i18n.t('errors.no_data_export') : 'No data to export. Please calculate first.';
        showError(errorMsg);
        return;
    }
    
    const formData = getFormData();
    const ec2Key = `aws_ec2_${formData.ec2InstanceType}`;
    const sakuraKey = `sakura_cloud_${formData.sakuraInstanceType}`;
    const gcpKey = `google_cloud_${formData.gcpInstanceType}`;
    const azureKey = `azure_${formData.azureInstanceType}`;
    const ociKey = `oci_${formData.ociInstanceType}`;

    const exchangeRate = parseFloat(formData.exchangeRate);
    const displayInJPY = formData.displayCurrency;
    const currencySymbol = displayInJPY ? 'JPY' : 'USD';
    const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'en';
    
    const formatCurrency = (usdValue) => {
        const value = displayInJPY ? usdValue * exchangeRate : usdValue;
        return displayInJPY ? Math.round(value) : value.toFixed(2);
    };
    
    // Get CSV labels from i18n
    const getCSVLabels = () => {
        if (window.i18n) {
            return {
                title: window.i18n.t('csv.title') || 'AWS Lambda vs VM Cost Comparison Report',
                generated_date: window.i18n.t('csv.generated_date') || 'Generated Date',
                exchange_rate: window.i18n.t('csv.exchange_rate') || 'Exchange Rate',
                lambda_config: window.i18n.t('csv.lambda_config') || 'Lambda Configuration',
                memory_mb: window.i18n.t('csv.memory_mb') || 'Memory (MB)',
                execution_time: window.i18n.t('csv.execution_time') || 'Execution Time (sec)',
                monthly_executions: window.i18n.t('csv.monthly_executions') || 'Monthly Executions',
                cost_comparison: window.i18n.t('csv.cost_comparison') || 'Cost Comparison',
                executions_month: window.i18n.t('table.headers.executions_month') || 'Executions/Month',
                lambda_cost: window.i18n.t('table.headers.lambda_cost') || 'Lambda Cost',
                breakeven_points: window.i18n.t('csv.breakeven_points') || 'Break-even Points',
                service: window.i18n.t('csv.service') || 'Service',
                executions_second: window.i18n.t('csv.executions_second') || 'Executions/Second'
            };
        } else {
            return {
                title: 'AWS Lambda vs VM Cost Comparison Report',
                generated_date: 'Generated Date',
                exchange_rate: 'Exchange Rate',
                lambda_config: 'Lambda Configuration',
                memory_mb: 'Memory (MB)',
                execution_time: 'Execution Time (sec)',
                monthly_executions: 'Monthly Executions',
                cost_comparison: 'Cost Comparison',
                executions_month: 'Executions/Month',
                lambda_cost: 'Lambda Cost',
                breakeven_points: 'Break-even Points',
                service: 'Service',
                executions_second: 'Executions/Second'
            };
        }
    };
    
    const csvLabels = getCSVLabels();
    const now = new Date();
    
    // Use appropriate locale for timestamp
    const locale = currentLang === 'ja' ? 'ja-JP' : 'en-US';
    const timestamp = now.toLocaleString(locale);
    
    // CSV with metadata and i18n support
    let csv = '\ufeff'; // UTF-8 BOM for Excel support
    csv += `"${csvLabels.title}"\n`;
    csv += `"${csvLabels.generated_date}","${timestamp}"\n`;
    csv += `"${csvLabels.exchange_rate}","${exchangeRate} JPY/USD"\n\n`;
    
    csv += `"${csvLabels.lambda_config}"\n`;
    csv += `"${csvLabels.memory_mb}","${csvLabels.execution_time}","${csvLabels.monthly_executions}"\n`;
    csv += `"${formData.lambdaMemory}","${formData.executionTime}","${formData.executionFrequency}"\n\n`;
    
    csv += `"${csvLabels.cost_comparison}"\n`;
    csv += `"${csvLabels.executions_month}","${csvLabels.lambda_cost} (${currencySymbol})"`;
    if (formData.compareEC2) csv += `,"EC2 ${formData.ec2InstanceType} (${currencySymbol})"`;
    if (formData.compareSakura) csv += `,"Sakura ${formData.sakuraInstanceType} (${currencySymbol})"`;
    if (formData.compareGCP) csv += `,"Google Cloud ${formData.gcpInstanceType} (${currencySymbol})"`;
    if (formData.compareAzure) csv += `,"Azure ${formData.azureInstanceType} (${currencySymbol})"`;
    if (formData.compareOCI) csv += `,"OCI ${formData.ociInstanceType} (${currencySymbol})"`;
    csv += '\n';
    
    comparisonData.forEach(row => {
        csv += `"${row.executions_per_month}","${formatCurrency(row.lambda_cost_usd)}"`;
        if (formData.compareEC2) csv += `,"${formatCurrency(row.vm_costs[ec2Key] || 0)}"`;
        if (formData.compareSakura) csv += `,"${formatCurrency(row.vm_costs[sakuraKey] || 0)}"`;
        if (formData.compareGCP) csv += `,"${formatCurrency(row.vm_costs[gcpKey] || 0)}"`;
        if (formData.compareAzure) csv += `,"${formatCurrency(row.vm_costs[azureKey] || 0)}"`;
        if (formData.compareOCI) csv += `,"${formatCurrency(row.vm_costs[ociKey] || 0)}"`;
        csv += '\n';
    });
    
    // Add break-even points if available
    if (lastBreakEvenData && lastBreakEvenData.length > 0) {
        csv += `\n"${csvLabels.breakeven_points}"\n`;
        csv += `"${csvLabels.service}","${csvLabels.executions_month}","${csvLabels.executions_second}"\n`;
        lastBreakEvenData.forEach(point => {
            const providerMap = {
                'aws_ec2': 'EC2',
                'sakura_cloud': 'Sakura',
                'google_cloud': 'GCP',
                'azure': 'Azure',
                'oci': 'OCI'
            };
            const providerName = providerMap[point.vm_provider] || point.vm_provider;
            csv += `"${providerName} ${point.vm_instance}","${point.executions_per_month}","${point.executions_per_second.toFixed(2)}"\n`;
        });
    }
    
    // Generate filename based on language
    const getFilename = () => {
        const dateString = now.toISOString().split('T')[0].replace(/-/g, '');
        const timeString = now.toTimeString().slice(0,8).replace(/:/g, '');
        
        if (currentLang === 'ja') {
            return `コスト比較結果_${dateString}_${timeString}.csv`;
        } else {
            return `cost_comparison_${dateString}_${timeString}.csv`;
        }
    };
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFilename();
    a.click();
    window.URL.revokeObjectURL(url);
}

// Check API connectivity
async function checkAPIConnectivity() {
    try {
        console.log('Checking API connectivity...');
        const response = await fetch('/api/v1/calculator/instances', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            console.log('✅ API is connected and responding');
        } else {
            console.warn('⚠️ API responded with status:', response.status);
            showError('API connection issue. Please refresh the page.');
        }
    } catch (error) {
        console.error('❌ API connectivity check failed:', error);
        showError('Unable to connect to API. Please check if the server is running.');
    }
}

// Load available instances from API
async function loadAvailableInstances() {
    try {
        const response = await fetch('/api/v1/calculator/instances');
        const result = await response.json();
        
        if (result.success) {
            // Instances are already populated in the HTML
            // This could be enhanced to dynamically populate dropdowns from API
            console.log('✅ Available instances loaded');
        }
    } catch (error) {
        console.error('Failed to load instances:', error);
    }
}

// Update VM recommendations based on Lambda memory
async function updateVMRecommendations() {
    const lambdaMemory = window.getLambdaMemoryValue();
    
    try {
        const response = await fetch('/api/v1/calculator/recommend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lambda_memory_mb: lambdaMemory
            })
        });
        
        const result = await response.json();
        
        if (result.success && result.data) {
            let recommendationText = '';
            
            // EC2 recommendations
            if (result.data.aws_ec2 && result.data.aws_ec2.length > 0) {
                const ec2Rec = result.data.aws_ec2[0];
                recommendationText += `EC2: ${ec2Rec.instance_type} `;
            }
            
            // Google Cloud recommendations
            if (result.data.google_cloud && result.data.google_cloud.length > 0) {
                const gcpRec = result.data.google_cloud[0];
                if (recommendationText) recommendationText += '| ';
                recommendationText += `GCP: ${gcpRec.instance_type} `;
            }
            
            // Azure recommendations
            if (result.data.azure && result.data.azure.length > 0) {
                const azureRec = result.data.azure[0];
                if (recommendationText) recommendationText += '| ';
                recommendationText += `Azure: ${azureRec.instance_type}`;
            }
            
            // OCI recommendations
            if (result.data.oci && result.data.oci.length > 0) {
                const ociRec = result.data.oci[0];
                if (recommendationText) recommendationText += '| ';
                recommendationText += `OCI: ${ociRec.instance_type}`;
            }
            
            document.getElementById('vmRecommendations').textContent = recommendationText || 'No recommendations available';
        }
    } catch (error) {
        console.error('Failed to get recommendations:', error);
        document.getElementById('vmRecommendations').textContent = 'Unable to load recommendations';
    }
}

// Show error message
function showError(message) {
    const errorTemplate = document.getElementById('errorTemplate');
    const errorClone = errorTemplate.cloneNode(true);
    errorClone.id = '';
    errorClone.classList.remove('d-none');
    errorClone.querySelector('#errorMessage').textContent = message;
    
    document.querySelector('main').insertBefore(errorClone, document.querySelector('main').firstChild);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorClone.remove();
    }, 5000);
}
</script>
{% endblock %}